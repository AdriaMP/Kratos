# Not including current dir (we want to force users to specify the mpi/ in the include path)
set(CMAKE_INCLUDE_CURRENT_DIR OFF)

include_directories( ${CMAKE_SOURCE_DIR}/kratos )

## Kratos MPI extension sources
set( KRATOS_MPI_SOURCES
   mpi_environment.cpp
)

## Kratos MPI extension Python interface
set( KRATOS_MPI_PYTHON_SOURCES
    python/kratos_mpi_python.cpp
    python/add_mpi_communicator_to_python.cpp
    python/add_mpi_data_communicator_to_python.cpp
    python/add_mpi_utilities_to_python.cpp
)

## Define library for the C++ layer
add_library(KratosMPICore SHARED ${KRATOS_MPI_SOURCES} )
target_link_libraries(KratosMPICore PUBLIC KratosCore ${MPI_LIBRARIES} )
#set_target_properties(KratosMPICore PROPERTIES COMPILE_DEFINITIONS "KRATOS_MPI_CORE=IMPORT,API")

## Define library for the Python interface layer
pybind11_add_module(KratosMPI MODULE THIN_LTO ${KRATOS_MPI_PYTHON_SOURCES})
# add_library(Kratos SHARED ${KRATOS_PYTHON_SOURCES})
target_link_libraries(KratosMPI PRIVATE KratosMPICore KratosCore )
# set_target_properties(KratosMPI PROPERTIES PREFIX "")

# Install library
install(TARGETS KratosMPICore DESTINATION libs )
install(TARGETS KratosMPI DESTINATION libs)

# Install python module
install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/mpi_module_init.py" DESTINATION "KratosMultiphysics/mpi" RENAME "__init__.py" )
